@startuml
title AI Agent Logic: Handling Auth & Conflicts

skinparam ActivityBackgroundColor #FEFECE
skinparam ActivityBorderColor #A80036
skinparam ArrowColor #333333

|User/Client|
start
:Initiate Service Booking\n(via Gemini/AI Agent);

|AI Agent|
:Analyze Requested Rebates\n& Service Coupons;

if (Is User Identified?) then (no)
    |Financial Flow System|
    :Status: **AUTHENTICATION_REQUIRED**;
    |AI Agent|
    :Trigger OIDC/OAuth 2.1 Flow;
    |User/Client|
    :Biometric Auth / Sign-in;
    |AI Agent|
    :Resume Financial Flow;
endif

|AI Agent|
:Validate Discount Stack;

if (Conflicting Rules?) then (yes)
    |Financial Flow System|
    :Status: **COMBINATION_DISALLOWED**;
    |AI Agent|
    :Calculate Best Value (Max Savings);
    :Present Trade-off to User:
    -- "Coupon A ($50) cannot be used with
    -- "Military Discount (10%).
    -- "I recommend Coupon A for $12 more savings.";
    |User/Client|
    :Select Preference;
    |AI Agent|
    :Re-submit with Single Offer;
else (no)
    |Financial Flow System|
    :Status: **APPLIED**;
endif

|Financial Flow System|
:Status: **COMPLETE**;
stop

@enduml